# Архитектура File Storage Service

## Общая архитектура

```
┌─────────────────┐
│ ResourceController │  ← REST API Layer
└────────┬──────────┘
         │
         ▼
┌─────────────────┐
│ FileStorageService │  ← Business Logic Layer
└────────┬──────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐  ┌──────────┐
│ MinIO  │  │PostgreSQL│  ← Storage Layer
└────────┘  └──────────┘
```

## Поток данных при загрузке файла

1. Client → POST `/api/v1/projects/{id}/resources`
2. ResourceController → валидация запроса
3. FileStorageService → проверка прав доступа
4. FileStorageService → проверка квоты хранилища (с pessimistic lock)
5. FileStorageService → валидация файла (размер, расширение)
6. FileStorageService → определение MIME-типа (Apache Tika)
7. FileStorageService → генерация уникального ключа
8. FileStorageService → загрузка в MinIO
9. FileStorageService → сохранение метаданных в PostgreSQL
10. FileStorageService → обновление размера хранилища проекта
11. Response → ResourceResponse с метаданными файла

## Выбор технологий

### MinIO - Объектное хранилище

**Почему MinIO?**

1. **S3-совместимый API**
   - Полная совместимость с Amazon S3 API
   - Легкая миграция на AWS S3 в будущем
   - Поддержка presigned URLs из коробки

2. **Простота развертывания**
   - Легковесный контейнер
   - Минимальные требования к ресурсам
   - Простая конфигурация

3. **Производительность**
   - Высокая скорость чтения/записи
   - Оптимизация для больших файлов
   - Поддержка multipart upload

4. **Self-hosted решение**
   - Полный контроль над данными
   - Отсутствие зависимости от внешних сервисов
   - Снижение затрат на хранение

**Альтернативы, которые были рассмотрены:**
- **AWS S3** - отложено из-за необходимости внешней зависимости и затрат
- **Local File System** - не подходит для масштабирования и распределенных систем
- **HDFS** - избыточно для текущих требований

### Apache Tika - Определение MIME-типов

**Почему Apache Tika?**

1. **Точность определения**
   - Анализ содержимого файла, а не только расширения
   - Поддержка 1000+ форматов файлов
   - Защита от подмены расширений

2. **Надежность**
   - Проверенный временем проект Apache
   - Активная поддержка сообщества
   - Регулярные обновления

3. **Производительность**
   - Легковесная библиотека
   - Кэширование результатов
   - Минимальное влияние на производительность

**Альтернативы:**
- **Определение по расширению** - небезопасно, легко обмануть
- **Определение по HTTP заголовкам** - ненадежно, клиент может подделать

### PostgreSQL - Хранение метаданных

**Почему PostgreSQL?**

1. **ACID гарантии**
   - Транзакционность операций
   - Консистентность данных
   - Надежность при конкурентном доступе

2. **Производительность**
   - Эффективные индексы для поиска
   - Оптимизированные запросы для агрегации
   - Поддержка блокировок

3. **Уже используется в проекте**
   - Единая инфраструктура БД
   - Простота интеграции
   - Снижение сложности системы

### PESSIMISTIC Locking для Project

**Почему PESSIMISTIC_WRITE, а не OPTIMISTIC?**

**При использовании OPTIMISTIC_LOCK:**
- При возникновении OptimisticLockException файл уже загружен в MinIO
- Требуется дополнительная логика отката (rollback) загрузки в MinIO
- Риск "висящих" файлов в хранилище при ошибках

**При использовании PESSIMISTIC_WRITE:**
- Блокировка записи происходит сразу при чтении
- Гарантируется атомарность операции проверки квоты и обновления
- Исключается race condition при параллельных загрузках
- Файл загружается в MinIO только после успешной проверки квоты

**Компромисс:**
- Небольшое снижение пропускной способности при высокой конкурентности
- Значительное повышение надежности и консистентности данных

## Основные компоненты

### ResourceController

REST контроллер, предоставляющий API для работы с файлами проекта.

**Основные методы:**
- `POST /api/v1/projects/{projectId}/resources` - загрузка файла
- `GET /api/v1/projects/{projectId}/resources/{resourceId}/download` - скачивание файла
- `GET /api/v1/projects/{projectId}/resources/{resourceId}/url` - получение presigned URL
- `DELETE /api/v1/projects/{projectId}/resources/{resourceId}` - удаление файла
- `GET /api/v1/projects/{projectId}/resources` - список файлов проекта (с пагинацией)
- `POST /api/v1/projects/{projectId}/resources/bulk` - массовая загрузка файлов

### FileStorageService

Центральный сервис, реализующий бизнес-логику работы с файлами.

**Ключевые функции:**

1. **Валидация файлов**
   - Проверка размера (max 500MB по умолчанию)
   - Проверка расширения (блокировка exe, bat, cmd, sh)
   - Определение MIME-типа через Apache Tika

2. **Управление квотами**
   - Проверка текущего размера хранилища проекта
   - Валидация перед загрузкой (с pessimistic lock)
   - Автоматическое обновление после операций

3. **Контроль доступа**
   - Проверка ролей пользователя
   - Валидация прав на чтение/удаление
   - Поддержка ролевой модели доступа

4. **Генерация ключей хранилища**
   ```
   Формат: project-{projectId}/{timestamp}-{uuid}-{sanitizedFileName}
   Пример: project-123/1703123456789-a1b2c3d4-document.pdf
   ```

### MinioConfig

Конфигурация клиента MinIO с автоматическим созданием bucket при старте приложения.

**Особенности:**
- Условная активация через `@ConditionalOnProperty`
- Обработка ошибок подключения в тестовом окружении
- Автоматическое создание bucket при отсутствии

## Модели данных

### Resource

Основная сущность, представляющая файл в системе.

**Поля:**
- `id: Long` - уникальный идентификатор
- `name: String` - оригинальное имя файла
- `key: String` - ключ в объектном хранилище
- `contentType: String` - MIME-тип файла
- `size: BigInteger` - размер файла в байтах
- `type: ResourceType` - категория файла
- `status: ResourceStatus` - статус (ACTIVE, DELETED)
- `allowedRoles: List<UserRole>` - роли с доступом к файлу
- `project: Project` - связь с проектом
- `createdBy/updatedBy: User` - автор и последний редактор

**Определение типа ресурса:**
Тип определяется автоматически на основе MIME-типа файла:
- `image/*` → IMAGE
- `video/*` → VIDEO
- `audio/*` → AUDIO
- `application/pdf` → PDF
- `application/msword` → MSWORD
- `application/vnd.ms-excel` → MSEXCEL
- `application/zip` → ZIP
- `text/*` → TEXT
- Неизвестный тип → OTHER или NONE

### Project (расширение)

Добавлены поля для управления хранилищем:

- `storageSize: BigInteger` - текущий размер хранилища
- `maxStorageSize: BigInteger` - максимальный размер (по умолчанию 2GB)

## Производительность

### Оптимизации

1. **Streaming загрузка/скачивание**
   - Файлы не загружаются полностью в память
   - Использование StreamingResponseBody для скачивания
   - Потоковая передача в MinIO

2. **Индексы БД**
   - Оптимизированные запросы для поиска файлов
   - Быстрая агрегация размера хранилища

3. **Pessimistic Locking**
   - Минимальное время блокировки
   - Блокировка только на время проверки квоты

### Рекомендации

- Использовать connection pooling для MinIO
- Настроить кэширование метаданных файлов (если требуется)
- Рассмотреть CDN для часто запрашиваемых файлов
- Мониторить размер bucket и настраивать lifecycle policies

## Будущие улучшения

### Потенциальные расширения

1. **Версионирование файлов**
   - Сохранение истории изменений
   - Возможность отката к предыдущей версии

2. **Шифрование**
   - Шифрование файлов на стороне сервера
   - Поддержка client-side encryption

3. **CDN интеграция**
   - Кэширование популярных файлов
   - Географическое распределение

4. **Асинхронная обработка**
   - Очереди для больших файлов
   - Фоновое сканирование на вирусы
   - Автоматическая генерация превью

5. **Расширенная аналитика**
   - Статистика использования хранилища
   - Отчеты по типам файлов
   - Мониторинг доступа
