# Безопасность и контроль доступа

## Ролевая модель доступа

Файлы могут быть ограничены определенными ролями участников проекта:

```java
// При загрузке можно указать разрешенные роли
POST /api/v1/projects/123/resources
  ?allowedRoles=MANAGER,DEVELOPER

// Если роли не указаны, доступ имеют все участники проекта
```

### Проверка доступа при скачивании

1. Проверка существования пользователя
2. Проверка наличия хотя бы одной разрешенной роли
3. Проверка статуса файла (только ACTIVE)

### Права на удаление

Удалять файлы могут:
- **Создатель файла** (`createdBy`)
- **Менеджер проекта** (роль `MANAGER` или `OWNER`)

## Валидация файлов

### Размер файла

- Максимальный размер: 500MB (настраивается через `file-storage.max-file-size`)
- Проверка до загрузки в хранилище
- Ошибка: `PAYLOAD_TOO_LARGE` (413)

### Расширения файлов

- Блокировка: `exe`, `bat`, `cmd`, `sh`
- Настраиваемый список через конфигурацию `file-storage.blocked-extensions`
- Ошибка: `IllegalArgumentException` (400)

### MIME-тип

- Определение через Apache Tika (анализ содержимого)
- Fallback на заголовок `Content-Type` от клиента
- Дефолтный тип: `application/octet-stream`
- Защита от подмены расширений

## Санитизация имен файлов

Имена файлов очищаются перед сохранением:

- Удаление специальных символов (regex: `[^a-zA-Z0-9.-]`)
- Замена на подчеркивания
- Приведение к нижнему регистру
- Удаление дублирующихся подчеркиваний

**Пример:**
```
"Мой Документ (2024).pdf" → "мой_документ_2024_.pdf"
```

## Генерация ключей хранилища

Формат ключа обеспечивает уникальность и структурированность:

```
project-{projectId}/{timestamp}-{uuid}-{sanitizedFileName}
```

**Пример:**
```
project-123/1703123456789-a1b2c3d4-document.pdf
```

**Преимущества:**
- Уникальность через timestamp + UUID
- Группировка по проектам
- Сохранение оригинального имени (санитизированного)

## Обработка ошибок безопасности

### Иерархия исключений

```
RuntimeException
├── EntityNotFoundException          (404) - сущность не найдена
├── ResourceNotFoundException        (404) - файл не найден
├── StorageLimitExceededException    (507) - превышена квота
├── IllegalArgumentException         (400) - невалидные параметры
├── IllegalStateException            (400) - недопустимое состояние
└── AccessDeniedException            (403) - нет доступа
```

### Стандартизированные ответы

Все ошибки возвращаются в едином формате:

```json
{
  "errorCode": "ACCESS_DENIED",
  "message": "User 123 does not have permission to access resource 456 in project 789"
}
```

## Контроль квот хранилища

### Механизм проверки

1. **Pessimistic Locking** на уровне проекта
   - Предотвращение race conditions
   - Гарантия атомарности проверки и обновления

2. **Автоматический пересчет**
   - После каждой загрузки/удаления
   - Агрегация только активных файлов
   - Обновление поля `storageSize` проекта

3. **Валидация перед загрузкой**
   - Проверка текущего размера + размер нового файла
   - Сравнение с `maxStorageSize`
   - Ошибка: `StorageLimitExceededException` (507)

### Настройка квот

- По умолчанию: 2GB на проект
- Настраивается через поле `maxStorageSize` в таблице `project`
- Можно установить индивидуально для каждого проекта

## Рекомендации по безопасности

1. **Использование HTTPS** в production
2. **Валидация всех входных данных**
3. **Логирование операций** с файлами
4. **Мониторинг** подозрительной активности
5. **Регулярное обновление** зависимостей
6. **Ограничение размера** запросов на уровне веб-сервера
7. **Rate limiting** для API endpoints

## Будущие улучшения

- Шифрование файлов на стороне сервера
- Интеграция с антивирусным сканированием
- Детальное аудит-логирование
- Двухфакторная аутентификация для критичных операций
- Интеграция с OAuth2/JWT для production
